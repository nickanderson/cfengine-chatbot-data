:PROPERTIES:
:ID:       7ba0df12-e46b-4885-95e1-63fe3befb032
:CREATED:  [2021-05-11 Tue 14:02]
:index: [[id:38277465-771a-4db4-983a-8dfd434b1aff][CFEngine_examples]]
:END:
#+title: Example illustrating run scripts in directory

I detected a process is not running, now I want to loop over the scripts in a folder (=/etc/mender/alerts.d=) and run the scripts, one by one, as ~/etc/mender/alerts.d/script-name $process~

#+CAPTION: Nick's Version
#+BEGIN_SRC cfengine3 :include-stdlib t :log-level info :exports both :command-in-result t :tangle /tmp/example.cf
  bundle agent __main__
  {
    methods:
        "Notify"
          usebundle => notify_not_running( "myemacs"),
          unless    => processexists( ".*myemacs.*" );

  }
  bundle agent notify_not_running(process)
  {
    vars:
        "script_dir" string => "/etc/mender/alerts.d";
        "script_dir" string => "/tmp/scripts";
        "scripts"
          slist => lsdir( $(script_dir), "^(?!(\.$|\.\.$)).*", false ),
          if => isdir( $(script_dir) );

    commands:
        "$(script_dir)/$(scripts) $(process)"
          action => if_elapsed( 60 ); # Note, running with -K or --no-lock will disregard this
  }
#+END_SRC

#+RESULTS:
: # cf-agent --no-lock --log-level info --file /tmp/example.cf
:     info: Executing 'no timeout' ... '/tmp/scripts/scriptn myemacs'
:   notice: Q: "...ts/scriptn myem": myemacs
:     info: Last 1 quoted lines were generated by promiser '/tmp/scripts/scriptn myemacs'
:     info: Completed execution of '/tmp/scripts/scriptn myemacs'
:     info: Executing 'no timeout' ... '/tmp/scripts/script1 myemacs'
:   notice: Q: "...ts/script1 myem": myemacs
:     info: Last 1 quoted lines were generated by promiser '/tmp/scripts/script1 myemacs'
:     info: Completed execution of '/tmp/scripts/script1 myemacs'

* References
- [[id:0d120ac3-81c0-415c-8b48-34d6e762c422][processexists()]]
